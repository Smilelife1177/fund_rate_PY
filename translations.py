from PyQt6.QtWidgets import QMainWindow, QVBoxLayout, QWidget, QPushButton, QLineEdit, QLabel, QDoubleSpinBox, QSlider, QComboBox, QCheckBox, QMessageBox, QTabWidget, QToolButton
from PyQt6.QtCore import QTimer, Qt
from PyQt6.QtGui import QIcon
from logic import get_account_balance, get_funding_data, get_current_price, get_next_funding_time, place_market_order, get_symbol_info, place_limit_close_order, update_ping, initialize_client, close_all_positions, get_optimal_limit_price, get_candle_open_price, place_stop_loss_order, get_order_execution_price
import os
import json
import time
import math

translations = {
    "en": {
        "window_title": "{} Funding Trader",
        "stop_loss_enabled_label": "Enable Stop Loss:",
        "stop_loss_enabled_checkbox": "Enable Stop Loss",
        "exchange_label": "Exchange:",
        "testnet_label": "Testnet Mode:",
        "testnet_checkbox": "Enable Testnet",
        "coin_input_label": "Enter Coin (e.g., BTCUSDT):",
        "update_coin_button": "Update Coin",
        "funding_interval_label": "Funding Interval (hours):",
        "entry_time_label": "Entry Time Before Funding (seconds):",
        "qty_label": "Order Quantity (qty):",
        "profit_percentage_label": "Desired Profit Percentage (%):",
        "auto_limit_label": "Automatic Limit Order:",
        "auto_limit_checkbox": "Enable Auto Limit",
        "leverage_label": "Leverage (x):",
        "stop_loss_percentage_label": "Stop Loss Percentage (%):",
        "funding_info_label": "Funding Rate: N/A | Time to Next Funding: N/A",
        "price_label": "Current Price: N/A",
        "balance_label": "Account Balance: N/A",
        "leveraged_balance_label": "Leveraged Balance: N/A",
        "volume_label": "Order Volume: N/A",
        "ping_label": "Ping: N/A",
        "refresh_button": "Refresh Data",
        "language_label": "Language:",
        "close_all_trades_button": "Close All Trades",
        "close_all_trades_warning_title": "Confirm Close All Trades",
        "close_all_trades_warning_text": "Are you sure you want to close all open trades? This action cannot be undone.",
        "close_all_trades_success": "All open trades have been closed.",
        "close_all_trades_no_positions": "No open trades to close.",
        "close_all_trades_error": "Error closing trades: {}",
        "new_tab_button": "New Tab",
        "tab_title": "Coin {}",
        "price_mismatch_warning_title": "Price Mismatch Warning",
        "price_mismatch_warning_text": "Limit price for {symbol} results in {actual_profit:.2f}% profit, expected {expected_profit:.2f}%",
        "price_validation_warning_title": "Price Validation Warning",
        "price_validation_warning_text": "Significant price discrepancy for {symbol}: Entry={entry_price:.6f}, Candle={candle_price:.6f}, Pre-Funding={pre_funding_price:.6f}. Using {selected_price:.6f}."
    },
    "uk": {
        "window_title": "{} Трейдер Фінансування",
        "exchange_label": "Біржа:",
        "stop_loss_enabled_label": "Увімкнути стоп-лосс:",
        "stop_loss_enabled_checkbox": "Увімкнути стоп-лосс",
        "testnet_label": "Режим тестування:",
        "testnet_checkbox": "Увімкнути тестовий режим",
        "coin_input_label": "Введіть монету (наприклад, BTCUSDT):",
        "update_coin_button": "Оновити монету",
        "funding_interval_label": "Інтервал фінансування (години):",
        "entry_time_label": "Час входу до фінансування (секунди):",
        "qty_label": "Кількість замовлення (qty):",
        "profit_percentage_label": "Бажаний відсоток прибутку (%):",
        "auto_limit_label": "Автоматичний лімітний ордер:",
        "auto_limit_checkbox": "Увімкнути автоматичний ліміт",
        "leverage_label": "Кредитне плече (x):",
        "stop_loss_percentage_label": "Відсоток стоп-лоссу (%):",
        "funding_info_label": "Ставка фінансування: N/A | Час до наступного фінансування: N/A",
        "price_label": "Поточна ціна: N/A",
        "balance_label": "Баланс рахунку: N/A",
        "leveraged_balance_label": "Баланс з урахуванням плеча: N/A",
        "volume_label": "Обсяг замовлення: N/A",
        "ping_label": "Пінг: N/A",
        "refresh_button": "Оновити дані",
        "language_label": "Мова:",
        "close_all_trades_button": "Закрити всі угоди",
        "close_all_trades_warning_title": "Підтвердження закриття всіх угод",
        "close_all_trades_warning_text": "Ви впевнені, що хочете закрити всі відкриті угоди? Цю дію неможливо скасувати.",
        "close_all_trades_success": "Усі відкриті угоди закрито.",
        "close_all_trades_no_positions": "Немає відкритих угод для закриття.",
        "close_all_trades_error": "Помилка при закритті угод: {}",
        "new_tab_button": "Нова вкладка",
        "tab_title": "Монета {}",
        "price_mismatch_warning_title": "Попередження про невідповідність ціни",
        "price_mismatch_warning_text": "Лімітна ціна для {symbol} призводить до прибутку {actual_profit:.2f}%, очікувалось {expected_profit:.2f}%",
        "price_validation_warning_title": "Попередження про перевірку ціни",
        "price_validation_warning_text": "Значна розбіжність цін для {symbol}: Вхід={entry_price:.6f}, Свічка={candle_price:.6f}, Перед фандингом={pre_funding_price:.6f}. Використовується {selected_price:.6f}."
    }
}